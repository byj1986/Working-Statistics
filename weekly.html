<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>过去7天使用趋势</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 复用 Daily 的布局样式，确保风格完全一致 */
        html, body { 
            height: 100%; margin: 0; padding: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: #f5f5f5; overflow: hidden; 
            display: flex; flex-direction: column;
        }

        .dashboard-wrapper {
            padding: 20px; height: 100%; box-sizing: border-box;
            display: flex; flex-direction: column;
            max-width: 1400px; margin: 0 auto; width: 100%;
        }
        
        /* 头部 */
        .header { 
            flex: 0 0 auto; display: flex; 
            justify-content: space-between; align-items: center; 
            margin-bottom: 20px; background: white;
            padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        h2 { margin: 0; color: #333; font-size: 20px; }
        
        /* 日期选择器 */
        .date-controls { display: flex; align-items: center; gap: 10px; }
        .date-label { font-size: 14px; color: #666; }
        input[type="date"] {
            padding: 8px 12px; font-size: 14px;
            border: 1px solid #ddd; border-radius: 6px;
            font-family: inherit; color: #555; outline: none;
        }

        /* 统计卡片 */
        .stats-grid { 
            flex: 0 0 auto; display: grid; 
            grid-template-columns: repeat(3, 1fr); gap: 20px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: white; padding: 20px; 
            border-radius: 8px; text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #ccc;
        }
        .stat-card.total { border-left-color: #4BC0C0; }
        .stat-card.active { border-left-color: #36A2EB; }
        .stat-card.idle { border-left-color: #FF9F40; }
        .stat-value { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* 内容区域 - 左右布局 */
        .content-area { 
            flex: 1; display: flex; gap: 20px; min-height: 0; 
        }
        
        /* 左图容器 */
        .left-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        /* 右图容器 */
        .right-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        .chart-wrapper { 
            flex: 1; background: #fff; border-radius: 8px; 
            padding: 15px; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
        }
        .chart-title { text-align: center; font-weight: 600; margin-bottom: 10px; color: #555; }
        .chart-container { flex: 1; position: relative; min-height: 0; }

        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #666; }
    </style>
</head>
<body>

<div class="dashboard-wrapper">
    <div class="header">
        <h2>过去 7 天使用概览</h2>
        <div class="date-controls">
            <span class="date-label">结束日期:</span>
            <input type="date" id="endDatePicker" onchange="onDateChange(this.value)">
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-value" id="totalRunWeek">-</div>
            <div class="stat-label">7天总开机时长</div>
        </div>
        <div class="stat-card active">
            <div class="stat-value" id="totalActiveWeek">-</div>
            <div class="stat-label">7天总有效使用</div>
        </div>
        <div class="stat-card idle">
            <div class="stat-value" id="totalIdleWeek">-</div>
            <div class="stat-label">7天总闲置</div>
        </div>
    </div>

    <div class="content-area">
        <div class="left-panel">
            <div class="chart-wrapper">
                <div class="chart-title">每日 有效 vs 闲置</div>
                <div class="chart-container">
                    <canvas id="weeklyTrendChart"></canvas>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="chart-wrapper">
                <div class="chart-title">7天应用使用总时长占比</div>
                <div class="chart-container">
                    <canvas id="weeklyAppChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let trendChart = null;
    let appChart = null;

    function formatMinutes(seconds) { return (seconds / 60).toFixed(1) + ' 分钟'; }
    function formatPrettyTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return `${h}小时 ${m}分`;
    }
    
    // 日期工具
    function toDashDate(str) { return str.replace(/^(\d{4})(\d{2})(\d{2})$/, "$1-$2-$3"); }
    
    // 生成过去7天的 YYYYMMDD 数组 (包含 endDate)
    function generatePast7Days(endDateStr) {
        const dates = [];
        // endDateStr 是 YYYY-MM-DD
        let current = new Date(endDateStr);
        
        for (let i = 0; i < 7; i++) {
            const y = current.getFullYear();
            const m = String(current.getMonth() + 1).padStart(2, '0');
            const d = String(current.getDate()).padStart(2, '0');
            dates.push(`${y}${m}${d}`);
            // 往前推一天
            current.setDate(current.getDate() - 1);
        }
        return dates.reverse(); // 从旧到新
    }

    // 初始化
    fetch('/api/dates')
        .then(r => r.json())
        .then(dates => {
            if (dates.length > 0) {
                // dates 是倒序的，dates[0] 是最新
                const maxDate = toDashDate(dates[0]); 
                const minDate = toDashDate(dates[dates.length - 1]);
                
                const picker = document.getElementById('endDatePicker');
                picker.max = maxDate;
                picker.min = minDate;
                picker.value = maxDate; // 默认选中最新一天作为结束

                onDateChange(maxDate);
            }
        });

    function onDateChange(endDateStr) {
        if (!endDateStr) return;
        const targetDates = generatePast7Days(endDateStr);
        loadWeekData(targetDates);
    }

    async function loadWeekData(targetDates) {
        // 并行拉取数据
        const requests = targetDates.map(date => 
            fetch(`/api/data/${date}`)
                .then(r => r.ok ? r.json() : null)
                .then(json => ({ date: date, data: json }))
                .catch(() => ({ date: date, data: null }))
        );

        const results = await Promise.all(requests);
        processData(results);
    }

    function processData(results) {
        let grandTotalRun = 0;
        let grandTotalIdle = 0;
        let grandTotalActive = 0;
        let aggregatedApps = {};
        let chartLabels = [];
        let dataActive = [];
        let dataIdle = [];

        results.forEach(item => {
            // 将 YYYYMMDD 格式化为 MM-DD 显示
            const dateStr = item.date;
            const formattedDate = `${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
            chartLabels.push(formattedDate);
            
            if (!item.data || !item.data.sessions || item.data.sessions.length === 0) {
                dataActive.push(0);
                dataIdle.push(0);
                return;
            }

            const json = item.data;
            const sessions = json.sessions || [];
            // sessions 格式: {start: "YYYY-MM-DD HH:MM:SS", end: "..."}
            let dayRun = 0;
            sessions.forEach(session => {
                if (session && session.start && session.end) {
                    const startTime = new Date(session.start).getTime();
                    const endTime = new Date(session.end).getTime();
                    // 验证日期是否有效
                    if (!isNaN(startTime) && !isNaN(endTime) && endTime > startTime) {
                        dayRun += (endTime - startTime) / 1000;
                    }
                }
            });
            // 确保值为有效数字
            dayRun = isNaN(dayRun) ? 0 : dayRun;
            const dayIdle = (json.idle_seconds && !isNaN(json.idle_seconds)) ? json.idle_seconds : 0;
            const dayActive = Math.max(0, dayRun - dayIdle);

            grandTotalRun += dayRun;
            grandTotalIdle += dayIdle;
            grandTotalActive += dayActive;

            dataActive.push(dayActive);
            dataIdle.push(dayIdle);

            const apps = json.apps || {};
            for (let appName in apps) {
                const appTotal = apps[appName].total || 0;
                if (!aggregatedApps[appName]) aggregatedApps[appName] = 0;
                aggregatedApps[appName] += appTotal;
            }
        });

        // 更新卡片
        document.getElementById('totalRunWeek').innerText = formatPrettyTime(grandTotalRun);
        document.getElementById('totalActiveWeek').innerText = formatPrettyTime(grandTotalActive);
        document.getElementById('totalIdleWeek').innerText = formatPrettyTime(grandTotalIdle);

        renderTrendChart(chartLabels, dataActive, dataIdle);
        renderAppChart(aggregatedApps);
    }

    function renderTrendChart(labels, activeData, idleData) {
        const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
        if (trendChart) trendChart.destroy();
        
        trendChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '有效使用', data: activeData, backgroundColor: '#36A2EB', stack: 'combined' },
                    { label: '闲置时长', data: idleData, backgroundColor: '#FF9F40', stack: 'combined' }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true, ticks: { callback: (val) => (val/3600).toFixed(0)+'h' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${formatPrettyTime(ctx.raw)}`,
                            footer: (items) => '总开机: ' + formatPrettyTime(items.reduce((a, b) => a + b.raw, 0))
                        }
                    }
                }
            }
        });
    }

    function renderAppChart(appDataObj) {
        const ctx = document.getElementById('weeklyAppChart').getContext('2d');
        if (appChart) appChart.destroy();

        let appsArray = Object.keys(appDataObj).map(name => ({ name, value: appDataObj[name] }));
        appsArray.sort((a, b) => b.value - a.value);

        const topN = 10;
        let displayData = appsArray.slice(0, topN);
        if (appsArray.length > topN) {
            displayData.push({ name: '其他应用', value: appsArray.slice(topN).reduce((acc, c) => acc + c.value, 0) });
        }

        appChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: displayData.map(d => d.name),
                datasets: [{
                    data: displayData.map(d => d.value),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#76A346', '#F28A8A', '#6B5B95', '#D3D3D3']
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12 } },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const val = ctx.raw;
                                const total = ctx.chart._metasets[ctx.datasetIndex].total;
                                const pct = total > 0 ? (val / total * 100).toFixed(1) + '%' : '0%';
                                return `${ctx.label}: ${formatMinutes(val)} (${pct})`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>