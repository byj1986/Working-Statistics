<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>每日使用统计报告</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- 全局布局 (保持不变) --- */
        html, body { 
            height: 100%; margin: 0; padding: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: #f5f5f5; overflow: hidden; 
            display: flex; flex-direction: column;
        }
        .dashboard-wrapper {
            padding: 20px; height: 100%; box-sizing: border-box;
            display: flex; flex-direction: column;
            max-width: 1400px; margin: 0 auto; width: 100%;
        }
        
        /* --- 头部与日期选择器 --- */
        .header { 
            flex: 0 0 auto; display: flex; 
            justify-content: space-between; align-items: center; 
            margin-bottom: 20px; background: white;
            padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        h2 { margin: 0; color: #333; font-size: 20px; }
        
        /* 日期控件样式优化 */
        input[type="date"] {
            padding: 8px 12px; font-size: 14px;
            border: 1px solid #ddd; border-radius: 6px;
            font-family: inherit; color: #555;
            outline: none; transition: border-color 0.2s;
        }
        input[type="date"]:focus { border-color: #36A2EB; }

        /* --- 统计卡片 --- */
        .stats-grid { 
            flex: 0 0 auto; display: grid; 
            grid-template-columns: repeat(3, 1fr); gap: 20px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: white; padding: 20px; 
            border-radius: 8px; text-align: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-left: 5px solid #ccc;
        }
        .stat-card.total { border-left-color: #4BC0C0; }
        .stat-card.active { border-left-color: #36A2EB; }
        .stat-card.idle { border-left-color: #FF9F40; }
        .stat-value { font-size: 28px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .stat-label { font-size: 14px; color: #888; text-transform: uppercase; letter-spacing: 1px; }

        /* --- 内容区 --- */
        .content-area { flex: 1; display: flex; gap: 20px; min-height: 0; }
        
        .chart-box { 
            flex: 4; display: flex; flex-direction: column; gap: 20px; 
            overflow-y: auto; padding-right: 5px; 
        }
        .chart-wrapper {
            background: #fff; border-radius: 8px; padding: 15px;
            min-height: 341px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
        }

        .details-box { 
            flex: 6; background: white; overflow-y: auto; 
            padding: 15px; border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* 列表与滚动条 */
        ul { list-style: none; padding-left: 0; margin: 0; }
        li { margin-bottom: 8px; }
        .app-row { 
            cursor: pointer; padding: 10px 15px; background: #f8f9fa; 
            display: flex; justify-content: space-between; 
            border-radius: 6px; font-size: 14px; transition: background 0.2s;
        }
        .app-row:hover { background: #e9ecef; }
        .app-name { font-weight: 600; color: #444; }
        .toggle-icon { margin-right: 8px; font-weight: bold; color: #999; display: inline-block; width: 16px; text-align: center;}
        .sub-list { padding-left: 35px; display: none; margin-top: 5px; border-left: 2px solid #eee; margin-left: 10px; }
        .sub-item { font-size: 13px; color: #666; display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee;}
        .active .sub-list { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="dashboard-wrapper">
    <div class="header">
        <h2>每日统计</h2>
        <!-- 替换为日期选择器 -->
        <input type="date" id="datePicker" onchange="onDateChange(this.value)">
    </div>

    <div class="stats-grid">
        <div class="stat-card total">
            <div class="stat-value" id="totalUsed">-</div>
            <div class="stat-label">系统运行时长</div>
        </div>
        <div class="stat-card active">
            <div class="stat-value" id="effectiveTime">-</div>
            <div class="stat-label">有效使用时间</div>
        </div>
        <div class="stat-card idle">
            <div class="stat-value" id="idleTime">-</div>
            <div class="stat-label">闲置时长</div>
        </div>
    </div>

    <div class="content-area">
        <div class="chart-box">
            <div class="chart-wrapper">
                <canvas id="summaryPieChart"></canvas>
            </div>
            <div class="chart-wrapper">
                <canvas id="usagePieChart"></canvas>
            </div>
        </div>
        <div class="details-box">
            <ul id="detailsList"></ul>
            <div id="noDataMsg" style="text-align:center; color:#999; margin-top:50px; display:none;">
                所选日期无数据
            </div>
        </div>
    </div>
</div>

<script>
    let usageChart = null;
    let summaryChart = null;
    let availableDates = []; // 存储所有可用日期 YYYYMMDD

    function secondsToMinutes(sec) { return (sec / 60).toFixed(1) + ' 分钟'; }
    function formatPrettyTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        return `${h}小时 ${m}分`;
    }
    function secondsToHMS(d) {
        d = Number(d); var h = Math.floor(d / 3600); var m = Math.floor(d % 3600 / 60); var s = Math.floor(d % 3600 % 60);
        return (h > 0 ? h + ":" + (m < 10 ? "0" : "") : "") + m + ":" + (s < 10 ? "0" : "") + s;
    }

    // 格式转换工具
    // YYYYMMDD -> YYYY-MM-DD
    function toDashDate(str) {
        return str.replace(/^(\d{4})(\d{2})(\d{2})$/, "$1-$2-$3");
    }
    // YYYY-MM-DD -> YYYYMMDD
    function toPlainDate(str) {
        return str.replace(/-/g, "");
    }

    // 初始化
    fetch('/api/dates')
        .then(r => r.json())
        .then(dates => {
            availableDates = dates; // 20251124, 20251123...
            const picker = document.getElementById('datePicker');
            
            if (dates.length > 0) {
                // 设置最大最小值
                // dates 是倒序的，dates[0] 是最新，dates[length-1] 是最早
                const maxDate = toDashDate(dates[0]);
                const minDate = toDashDate(dates[dates.length - 1]);
                
                picker.max = maxDate;
                picker.min = minDate;
                picker.value = maxDate; // 默认选中最新
                
                loadReport(dates[0]);
            }
        });

    function onDateChange(dateStr) {
        if(!dateStr) return;
        const plainDate = toPlainDate(dateStr);
        loadReport(plainDate);
    }

    function loadReport(date) {
        fetch(`/api/data/${date}`)
            .then(r => {
                if(!r.ok) throw new Error("No Data");
                return r.json();
            })
            .then(data => {
                // 检查是否有实际数据
                const hasData = data.sessions && data.sessions.length > 0;
                if (hasData) {
                    document.getElementById('noDataMsg').style.display = 'none';
                    document.getElementById('detailsList').style.display = 'block';
                    renderDashboard(data);
                } else {
                    document.getElementById('noDataMsg').style.display = 'block';
                    document.getElementById('detailsList').style.display = 'none';
                    clearDashboard();
                }
            })
            .catch(err => {
                // 处理无数据情况
                document.getElementById('noDataMsg').style.display = 'block';
                document.getElementById('detailsList').style.display = 'none';
                clearDashboard();
            });
    }

    function clearDashboard() {
        document.getElementById('totalUsed').innerText = '-';
        document.getElementById('effectiveTime').innerText = '-';
        document.getElementById('idleTime').innerText = '-';
        if(usageChart) usageChart.destroy();
        if(summaryChart) summaryChart.destroy();
    }

    function renderDashboard(data) {
        const sessions = data.sessions || [];
        let totalRunSeconds = 0;
        if (sessions.length > 0) {
            // sessions 格式: {start: "YYYY-MM-DD HH:MM:SS", end: "..."}
            sessions.forEach(session => {
                if (session && session.start && session.end) {
                    const startTime = new Date(session.start).getTime();
                    const endTime = new Date(session.end).getTime();
                    // 验证日期是否有效
                    if (!isNaN(startTime) && !isNaN(endTime) && endTime > startTime) {
                        totalRunSeconds += (endTime - startTime) / 1000;
                    }
                }
            });
        }
        // 确保值为有效数字
        totalRunSeconds = isNaN(totalRunSeconds) ? 0 : totalRunSeconds;
        const idleSeconds = (data.idle_seconds && !isNaN(data.idle_seconds)) ? data.idle_seconds : 0;
        let effectiveSeconds = Math.max(0, totalRunSeconds - idleSeconds);

        document.getElementById('totalUsed').innerText = formatPrettyTime(totalRunSeconds);
        document.getElementById('effectiveTime').innerText = formatPrettyTime(effectiveSeconds);
        document.getElementById('idleTime').innerText = formatPrettyTime(idleSeconds);

        // 应用列表
        const appsObj = data.apps || {};
        let appsArray = Object.keys(appsObj).map(exeName => {
            const appData = appsObj[exeName];
            const titlesArray = Object.entries(appData.titles).map(([title, time]) => ({
                title, time
            })).sort((a, b) => b.time - a.time);
            return { name: exeName, total: appData.total, titles: titlesArray };
        });
        appsArray.sort((a, b) => b.total - a.total);

        const list = document.getElementById('detailsList');
        list.innerHTML = '';
        appsArray.forEach(app => {
            const li = document.createElement('li');
            const row = document.createElement('div');
            row.className = 'app-row';
            row.innerHTML = `<span class="app-name"><span class="toggle-icon">+</span> ${app.name}</span> <span>${secondsToMinutes(app.total)}</span>`;
            row.onclick = () => {
                li.classList.toggle('active');
                row.querySelector('.toggle-icon').innerText = li.classList.contains('active') ? '-' : '+';
            };
            const subDiv = document.createElement('div');
            subDiv.className = 'sub-list';
            app.titles.forEach(t => {
                const item = document.createElement('div');
                item.className = 'sub-item';
                const cleanTitle = t.title.length > 50 ? t.title.substring(0, 50) + '...' : t.title;
                item.innerHTML = `<span title="${t.title}">${cleanTitle}</span> <span>${secondsToHMS(t.time)}</span>`;
                subDiv.appendChild(item);
            });
            li.appendChild(row); li.appendChild(subDiv); list.appendChild(li);
        });

        renderCharts(effectiveSeconds, idleSeconds, appsArray);
    }

    function renderCharts(active, idle, appsArray) {
        const ctxSummary = document.getElementById('summaryPieChart').getContext('2d');
        if (summaryChart) summaryChart.destroy();
        const total = active + idle;
        summaryChart = new Chart(ctxSummary, {
            type: 'pie',
            data: {
                labels: ['有效使用', '闲置'],
                datasets: [{ data: [active, idle], backgroundColor: ['#36A2EB', '#FF9F40'], borderWidth: 1 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: '时间分配总览', font: { size: 16 } },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${secondsToMinutes(ctx.raw)} (${total>0?(ctx.raw/total*100).toFixed(1)+'%':'0%'})` } }
                }
            }
        });

        const ctxUsage = document.getElementById('usagePieChart').getContext('2d');
        if (usageChart) usageChart.destroy();
        const topN = 8;
        let displayData = appsArray.slice(0, topN).map(a => ({ name: a.name, value: a.total }));
        if (appsArray.length > topN) {
            displayData.push({ name: '其他应用', value: appsArray.slice(topN).reduce((acc, c) => acc + c.total, 0) });
        }
        usageChart = new Chart(ctxUsage, {
            type: 'doughnut',
            data: {
                labels: displayData.map(d => d.name),
                datasets: [{
                    data: displayData.map(d => d.value),
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED', '#76A346', '#F28A8A', '#6B5B95']
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: '应用程序使用占比', font: { size: 16 } },
                    legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${secondsToMinutes(ctx.raw)}` } }
                }
            }
        });
    }
</script>
</body>
</html>